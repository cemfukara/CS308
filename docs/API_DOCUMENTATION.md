# API DOCUMENTATION

<font size="6"><span style="color:red">Warning!</span> This document subject to change during development</font>

## Overview

<font size="4">This document describes the REST API endpoints for project backend, and explains usage.</font>

- All data is exchanged in JSON.

- Authentication is handled via JWT tokens in the Authorization header.

- Error messages follow a consistent format:
  ```
  {
      "message": "Error description"
  }
  ```

## Authentication

Authentication is done via JWT cookie. Private routes are checking for a valid JWT cookie, then grant access if role in the cookie matches the required role

- To be implemented: Refresh tokens that will used to refresh access tokens

|     Access      |      Role       |                     Description                      |
| :-------------: | :-------------: | :--------------------------------------------------: |
|     Public      |        -        |              Can be accessed by anyone               |
|     Private     |    customer     |          Can be accessed by logged in users          |
| Product Manager | product manager |          Can be accessed by product manager          |
|  Sales Manager  |  sales manager  |           Can be accessed by sales manager           |
|  Support Agent  |  support agent  |           Can be accessed by support agent           |
|        -        |       dev       | "dev" role can access to any route (in dev env only) |

### JWT Token Contents

Payload of a JWT cookie consist:

```
{
  "user_id": 0,
  "email": "dev@test.local",
  "role": "dev",

  // these lines are generated by JWT automatically
  "iat": 1764280120,
  "exp": 1764884920
}
```

# API Endpoints

## Admin Routes

api/admin/

### Sales Manager

| METHOD |       ENDPOINT       |                 DESCRIPTION                 |    ACCESS     |     STATUS      |
| :----: | :------------------: | :-----------------------------------------: | :-----------: | :-------------: |
|  GET   |      /analytics      | Get sales revenue / profit / loss analytics | Sales Manager | Not Implemented |
|  GET   |      /invoices       |     View invoices in a given date range     | Sales Manager | Not Implemented |
|  GET   | /invoices/:id/export |            Export invoice as PDF            | Sales Manager | Not Implemented |
| PATCH  |      /discounts      |      Apply or update product discounts      | Sales Manager | Not Implemented |
| PATCH  | /refunds/:id/approve |     Approve or decline a refund request     | Sales Manager | Not Implemented |

### Product Manager

| METHOD |        ENDPOINT        |             DESCRIPTION             |     ACCESS      |     STATUS      |
| :----: | :--------------------: | :---------------------------------: | :-------------: | :-------------: |
|  GET   |      /deliveries       | View list of orders to be delivered | Product Manager |    Finished     |
| PATCH  | /deliveries/:id/status |    Update order delivery status     | Product Manager |    Finished     |
| PATCH  | /comments/:id/approve  | Approve or reject product comments  | Product Manager | Not Implemented |

### Support Agent

| METHOD |           ENDPOINT           |                  DESCRIPTION                  |    ACCESS     |     STATUS      |
| :----: | :--------------------------: | :-------------------------------------------: | :-----------: | :-------------: |
|  GET   |     /support/chat/queue      |      List active customer chat requests       | Support Agent | Not Implemented |
|  GET   |  /support/chat/:id/context   | View customer context (orders, cart, profile) | Support Agent | Not Implemented |
|  POST  |  /support/chat/:id/message   |              Send a chat message              | Support Agent | Not Implemented |
|  POST  | /support/chat/:id/attachment |        Send a file attachment in chat         | Support Agent | Not Implemented |
| PATCH  |   /support/chat/:id/claim    |             Claim a chat session              | Support Agent | Not Implemented |

## User Endpoints

api/users/

| METHOD | ENDPOINT  |             DESCRIPTION              | Access  |  Status  |
| :----: | :-------: | :----------------------------------: | :-----: | :------: |
|  POST  | /register |         Register a new user          | Public  | Finished |
|  POST  |  /login   |  Authenticate user and return token  | Public  | Finished |
|  GET   | /profile  |  Get logged-in user's profile info   | Private | Finished |
| PATCH  | /profile  | Update logged-in user's profile info | Private | Finished |

## Product Endpoints

api/products/

| METHOD |  ENDPOINT  |        DESCRIPTION        |     Access      |     Status      |
| :----: | :--------: | :-----------------------: | :-------------: | :-------------: |
|  GET   |     /      |     Get all products      |     Public      | Not Implemented |
|  GET   |    /:id    | Get single product by ID  |     Public      | Not Implemented |
| PATCH  | /:id/stock | Update stock of a product | Product Manager | Not Implemented |
|  POST  |     /      |     Add a new product     | Product Manager | Not Implemented |
|  PUT   |    /:id    |   Update product by ID    | Product Manager | Not Implemented |
| DELETE |    /:id    |   Delete product by ID    | Product Manager | Not Implemented |

## Category Endpoints

api/categories

| METHOD |   ENDPOINT    |                   DESCRIPTION                   |     Access     |  Status  |
| :----: | :-----------: | :---------------------------------------------: | :------------: | :------: |
|  GET   |       /       |           Get all product categories            |     Public     | Finished |
|  POST  |       /       |              Create a new category              | ProductManager | Finished |
|  PUT   |     /:id      |         Update category name or details         | ProductManager | Finished |
| DELETE |     /:id      |                Delete a category                | ProductManager | Finished |
|  PUT   | /:id/reassign | Reassign products under one category to another | ProductManager | Finished |

## Cart Endpoints

api/cart

| METHOD |      ENDPOINT      |           DESCRIPTION           | Access  |     Status      |
| :----: | :----------------: | :-----------------------------: | :-----: | :-------------: |
|  GET   |         /          |     Get user's current cart     | Private | Not Implemented |
|  POST  |        /add        |   Add product to user's cart    | Private | Not Implemented |
|  PUT   |      /update       | Update quantity or item in cart | Private | Not Implemented |
| DELETE | /remove/:productId |    Remove product from cart     | Private | Not Implemented |

## Order Endpoints

api/orders/

| METHOD |  ENDPOINT   |                  DESCRIPTION                   |     Access     |     Status      |
| :----: | :---------: | :--------------------------------------------: | :------------: | :-------------: |
|  GET   |      /      |       Get all orders for logged-in user        |    Private     | Not Implemented |
|  GET   |    /:id     |            Get order details by ID             |    Private     | Not Implemented |
|  POST  |      /      |         Create a new order (checkout)          |    Private     | Not Implemented |
| DELETE |    /:id     |                Cancel an order                 |    Private     | Not Implemented |
| PATCH  | /:id/status | Update order status (e.g., shipped, delivered) | ProductManager | Not Implemented |

## Wishlist Endpoints

api/wishlist/

| METHOD | ENDPOINT |                DESCRIPTION                 | Access  |  Status  |
| :----: | :------: | :----------------------------------------: | :-----: | :------: |
|  GET   |    /     | Get all wishlist items for logged-in user  | Private | Finished |
|  POST  |    /     | Adds item (in req body) to user's wishlist | Private | Finished |
| DELETE |   /:id   |           Delete a wishlist item           | Private | Finished |
| DELETE |    /     |           Clears user's wishlist           | Private | Finished |

# Usages

## User Usage

### POST api/users/register

Registers the user with given credentials

- Request Body:

  ```
  {
      "full_name":"Ali Mehmet Y覺lmaz",
      "email":"alimemo@provider.com",
      "password":"alimemoy覺lmaz"
  }
  ```

- Response Body:

  ```
  {
    // http status: 201
    "message": "User registered successfully",
    "user": {
        "full_name": "Ali Mehmet Y覺lmaz",
        "user_id": auto_incremented_id,
        "email": "alimemo@provider.com"
    }
  }
  ```

- Error:
  ```
  { "message": 'Email and password required'} // http status: 400
  OR
  { "message": 'Email already registered'} // http status: 409
  OR
  { "message": 'Server error' } // http status: 500
  ```

### POST api/users/login

Try to log the user in with given credentials

- Request Body:

  ```
    {
        "email": "user_email",
        "password": "user_password"
    }
  ```

- Response Body (+ JWT cookie):

  ```
  {"message": 'Login successful'} // http status: 201
  ```

- Error:
  ```
  { "message": 'Invalid credentials' } // http status: 401
  OR
  { "message": 'Server error' } // http status: 500
  ```

### GET api/users/profile

Returns user information

- Request Body (+ JWT cookie):

  ```
  // Empty body, authentication done by JWT cookie
  ```

- Response Body:

  ```
  {
    "id":19,
    "email":"alimemo@provider.com",
    "firstName": Ali Mehmet,
    "lastName": Y覺lmaz,
    "taxId":123456, // can be null
    "address": "Tuzla/ISTANBUL", // can be null
    "role":"user_role",
    "createdAt":"2025-11-19T13:48:11.000Z"
  }
  // http status: 200
  ```

- Error:
  ```
  { "message": 'User not found' } // http status: 404
  OR
  { "message": 'Server error' } // http status: 500
  ```

### PATCH api/users/profile

Updates the user info with given fields

- Request Body (+ JWT cookie):
  - Request body is includes parameters to be updated. At least one parameter is required. Not updated parameters not required. These parameters can be:
  ```
  { // Possible update fields
    "first_name":"new name"
    "last_name":"new last name"
    "email"="new email"
    "address":"new address"
    "tax_id":"new tax id"
  }
  ```
- Response Body (+ new JWT cookie if email is updated):
  ```
  { "message": 'Profile updated successfully' } // http status: 200
  ```
- Error:
  ```
  { "message": 'Server error' } // http status: 500
  OR
  { "message": 'No valid fields to update.' } // http status: 400
  OR
  { "message": 'Invalid email format.' } // http status: 400
  OR
  { "message": `Invalid field: ${key}` } // Invalid key in request body. http status: 400
  ```

## Wishlist Usage

### GET api/wishlist

Get all items in user's wishlist

- Request body (+ JWT cookie):

  ```
  // Empty, authentication done via JWT cookie
  ```

- Response body:

  ```
  {
      "wishlist": [product_details] // Empty array if whistles is empty
  } // http status: 200
  ```

- Error:
  ```
  { "message": 'Server error' } // http status: 500
  ```

### POST api/wishlist/

Add an item to user's wishlist

- Request body (+ JWT cookie):

  ```
  {"product_id":product_id}
  ```

- Response body:

  ```
  {
      "message": 'Product added to wishlist',
      "wishlist": {
        "id": wishlist_id, // Auto incremented at db
        product_id,
      }
  } // http status: 201
  ```

- Error:
  ```
  { "message": 'Invalid product_id' } // http status: 400
  OR
  { "message": 'Product not found' } // http status: 404
  OR
  { "message": 'Product already in wishlist' } // http status: 409
  OR
  { "message": 'Server error' } // http status: 500
  ```

### DELETE api/wishlist/:id

Deletes the item specified in the parameter

- Request body (+ JWT cookie):

  ```
  // Empty, authentication done via JWT cookie
  ```

- Response body:

  ```
  {
   " message" : `product_id:${product_id} is removed from wishlist`
  } // http status: 200
  ```

- Error:
  ```
  { "message": 'Invalid product_id' } // http status: 400
  OR
  { "message": 'Item not found in wishlist' } // http status: 404
  OR
  {" message": 'Server error' } // http status: 500
  ```

### DELETE api/wishlist/

Clears user's wishlist

- Request body (+ JWT cookie):

  ```
  // Empty, authentication done via JWT cookie
  ```

- Response body:

  ```
  {
      "message": 'Wishlist cleared successfully',
      "deleted": deletedCount, // Deleted item count
  } // http status: 200
  ```

- Error:
  ```
  { "message": 'Wishlist already empty', } // http status: 200
  OR
  {" message": 'Server error' } // http status: 500
  ```

## Product Manager Usage

### GET /api/product-manager/deliveries

Gets all orders with "processing" status

- Request body (+ JWT cookie):

  ```
  // Empty, authentication done via JWT cookie
  ```

- Response body:

  ```
  {
    // If not any order with "processing" status, then an empty array will shown
    "deliveries": [

      // one object for each order_id
      {
        "order_id": 3,
        "status": "processing",
        "total_price": "899.50",

        // PIIs, they will be decrypted
        "shipping_address": null,
        "user": {
          "first_name": null,
          "last_name": null,
          "address": null,
          "tax_id": null
        },

        // All products an their quantities
        "products": [
          {
            "id": 5,
            "name": "Zenith Z-Book 14",
            "quantity": 1
          }
        ]
      }
    ]
  } // http status: 200
  ```

- Error:
  ```
  {" message": 'Server error' } // http status: 500
  ```

### PATCH /api/product-manager/deliveries/:id/status

Change status of an order

- Request body (+ JWT cookie):

  ```
  // Authentication done via JWT cookie

  {"status":"in-transit"}

  /* Possible status values:
    "processing",
    "in-transit",
    "delivered",
    "cancelled",

    updating status to "cart" is not allowed
  */
  ```

- Response body:

  ```
  {"message":"Delivery status updated"} // http status: 200
  ```

- Error:
  ```
  {"message":"Invalid status value"} // http status: 400
  OR
  {"message":"Invalid order id"} // http status: 400
  OR
  {"message":"Order not found"} // http status: 404
  OR
  {" message": 'Server error' } // http status: 500
  ```
